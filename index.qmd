---
format: 
  revealjs:
    slide-number: true
    logo: images/future-logo.png
    footer: <https://future.p2p.futureverse.org>
    include-in-header: heading-meta.html
    code-copy: true
    center-title-slide: false
    code-link: true
    code-overflow: wrap
    highlight-style: a11y
    width: 1600
    height: 900
    margin: 0.02
    theme: [simple, assets/futureverse.scss]
    css: [assets/custom.css, assets/syntax-highlight.css]
    chalkboard: 
      buttons: false
    preview-links: auto
    pointer:
      pointerSize: 32

revealjs-plugins:
  - pointer
  - bsicons

execute:
  eval: false
  echo: true
---

<h1>Futureverse P2P:<br>Peer-to-Peer Parallelization in R</h1>

<h2>_- Share compute among friends across the world_</h2>

<br/>

### Henrik Bengtsson

University of California, San Francisco<br>
R Foundation, R Consortium<br>
{{< bi github >}} {{< bi mastodon >}} {{< bi bluesky >}} \@HenrikBengtsson<br>

![](images/future-logo.png){fig-alt="The hexlogo of the future package. A left-facing arrow with the text future underneath - both in bold style filled with yellow-to-orange vertical gradient. The background is dark blue with teeny star-shaped symbols in distance resembling looking deep out in the universe. The hexlogo is surrounded by a light-blue border." .absolute top=20 right=40 width="250"}
![](images/world-p2p-network-three-users.png){fig-alt="Illustration of three people working on laptops, positioned below a large globe with location markers connected by lines, representing global online collaboration." .absolute top=380 right=-10 width="350"}

<br/>

#### useR! 2025, Durham, NC, USA (2025-08-10)



## Future ... what?

:::: {.columns}

::: {.column width="35%" font="150%" .fragment}
An R assignment:
```{r}
#| code-line-numbers: false
a <- 1 + 2
```
:::

::: {.column width="10%"}
:::

::: {.column width="45%" font="150%" .fragment}
A future-value assignment:
```{r}
#| code-line-numbers: false
f <- future({ 1 + 2 })
a <- value(f)
```
:::

<br>

::: {.column width="35%" font="150%" .fragment}
```{r}
#| code-line-numbers: false
x <- 1:10
b <- slow_sum(x)
```
:::

::: {.column width="10%"}
:::

::: {.column width="45%" font="150%" .fragment}
```{r}
#| code-line-numbers: false
x <- 1:10
f <- future({ slow_sum(x) })
b <- value(f)
```
:::

::::


## Future ... why? (bc enables parallel processing)

:::: {.columns}

::: {.column width="42%" font="135%" .fragment}
Two calculations:
```{r}
#| code-line-numbers: "1-2|1-3|1-4|"
x_a <- 1:10
x_b <- 11:20
a <- slow_sum(x_a) # 1 min
b <- slow_sum(x_b) # 1 min
c <- a + b
```

::: {.fragment}
Total time: 2 mins
:::

:::



::: {.column width="58%" font="125%" .fragment}
Two futures:
```{r}
#| code-line-numbers: "1-2|1-3|1-4|1-6|1-7|"
x_a <- 1:10
x_b <- 11:20
f_a <- future( slow_sum(x_a) ) # 0 sec
f_b <- future( slow_sum(x_b) ) # 0 sec

a <- value(f_a)                # 1 min
b <- value(f_b)              
c <- a + b
```

::: {.fragment}
Total time: 1 mins
:::

:::

::::

. . .

<br>

### => futures are the core building block for parallel processing


## Futureverse allows you to stick with your favorite coding style

Parallel alternatives to traditional, sequential functions:

```{r}
#| code-line-numbers: "1|"
ys <- lapply(xs, slow_sum)                    # base R
ys <- future_lapply(xs, slow_sum)             # {future.apply}
```
<span style="height:10px"/>
<br>

. . .


```{r}
#| code-line-numbers: "1|"
ys <- map(xs, slow_sum)                       # {purrr}
ys <- future_map(xs, slow_sum)                # {furrr}
```

. . .

<br>


```{r}
#| code-line-numbers: "1|2|3|4|5"
plan(multisession)
plan(future.callr::callr)
plan(future.mirai::mirai_multisession)
plan(cluster, workers = c("n1", "desktop", "server.myuniv.org"))
plan(future.batchtools::batchtools_slurm)
```



## {data-background-color=#D0F0FF}

<center style="font-size: 400%; padding-top: 3.5ex;">
Let's go back in time ...
</center>


## Ten-Year Anniversary (future 0.6.0 released June 2015)

<center>
![](images/future-logo-balloons.png){fig-alt="Hexagon-shaped sign with the word 'FUTURE' in bold orange letters and the URL futureverse.org below, surrounded by a background of blue balloons." width="40%"}

<small>
_future logo: **Dan LaBar**_, 
_ggplot2 logo balloon wall: **Greg Swinehart** & **Hadley Wickham**_
</small>
</center>


## useR! 2016 at Stanford, CA, USA

<center>
<img src="images/useR2016-slide-01.png" style="width: 60%; border: 2px solid black; padding: 10px; box-shadow: 5px 10px gray;" alt="Screenshot of presentation slide titled 'A Future for R' by Henrik Bengtsson, UC San Francisco, with a retro illustration of a futuristic flying car on a highway. Caption at the bottom reads 'useR 2016, Stanford, CA, 2016-06-28'.">
</center>

## useR! 2016 at Stanford, CA, USA

<center>
<img src="images/useR2016-slide-05.png" style="width: 60%; border: 2px solid black; padding: 10px; box-shadow: 5px 10px gray;" alt="Screenshot of presentation slide titled 'R package: future' listing features: simple unified API, works on all platforms, easy to install, lightweight (~300 kB incl. dependencies), vignettes, and extendable by anyone. Badges at the bottom show CRAN 1.0.0, build passing, and Codecov 97%. Slide number 5 of 18.">
</center>



## useR! 2016 at Stanford, CA, USA

<center>
<img src="images/useR2016-slide-07.png" style="width: 60%; border: 2px solid black; padding: 10px; box-shadow: 5px 10px gray;" alt="Screenshot of presentation slide titled 'Consistent futures everywhere' listing Unix, macOS, and Windows. Shows R code using the future package to set plan(multiprocess) highlighted and run a Mandelbrot demo. Output indicates completion of several regions. On the right, an R graphics window displays a colorful Mandelbrot fractal.">
</center>



## useR! 2016 at Stanford, CA, USA

<center>
<img src="images/useR2016-slide-12.png" style="width: 60%; border: 2px solid black; padding: 10px; box-shadow: 5px 10px gray;" alt="Screenshot of presentation slide titled 'future.BatchJobs: Futures for HPC' showing a table mapping future.BatchJobs backends to job schedulers, such as batchjobs_slurm for Slurm and batchjobs_sge for Sun Grid Engine. Includes R code loading future.BatchJobs, setting plan(batchjobs_slurm) highlighted, and running DNA sequence alignment in parallel. Badges show CRAN 0.12.1, build passing, and Codecov 90%. Slide number 12 of 18.">
</center>



## useR! 2016 at Stanford, CA, USA

<center>
<img src="images/useR2016-slide-27.png" style="width: 60%; border: 2px solid black; padding: 10px; box-shadow: 5px 10px gray;" alt="Presentation slide titled 'A7. Futures I'd like to see' listing three ideas: plan(r32) for 32-bit R support, plan(p2p) for private and/or community-based peer-to-peer computer clusters, and plan(rhelp) to post R scripts to R-help for results. The text 'plan(p2p)' and its description are highlighted in orange.">
</center>



## {data-background-color=#D0F0FF}

<center style="font-size: 400%; padding-top: 3.5ex;">
Back to the present
</center>


## future.p2p: sharing compute among friends - it's easy!

<div style="height: 0.5ex"></div>

::: {.column width="70%" font="150%"}
```{r}
#| code-line-numbers: false
library(future.apply)

plan(future.p2p::cluster, cluster = "alice/friends")

y <- future_lapply(xs, slow_sum)
```
:::

![](images/world-p2p-network-three-users.png){fig-alt="Illustration of three people working on laptops, positioned below a large globe with location markers connected by lines, representing global online collaboration." .absolute top=280 right=-10 width="550"}



## {data-background-color=#D0F0FF}

<center style="font-size: 400%; padding-top: 2.5ex;">
How to get started ...
</center>


## A P2P cluster has two components

:::: {.fragment}

::: {.column width="65%" font="100%"}
<span style="font-size: 180%">Message Board</span>

Used to announce futures and offers to do work
<br>
(centralized; lightweight - only metadata)
:::

::: {.column width="30%" font="100%"}
![](images/message_board.png){fig-alt="Illustration of a bulletin board labeled 'Message Board' with six pinned notes, alternating between 'REQUEST' and 'OFFER' in yellow and blue squares." width="350"}
:::

::::

:::: {.fragment}

::: {.column width="65%" font="100%"}
<span style="font-size: 180%">P2P file-transfer protocol</span>

Used to send futures to workers and receive results
<br>
(peer-to-peer; full-size data transfers)
:::

::: {.column width="30%" font="100%"}
![](images/p2p-file-transfers.png){fig-alt="Diagram of three laptops connected in a triangular network, with arrows indicating file transfer between each pair." width="350"}
:::

::::


## To join a P2P cluster you need an account

All P2P cluster users need an [pico.sh](https://pico.sh) account to
access the message board:

:::: {.columns}

::: {.column width="50%" font-size="40%"}

### 1. `ssh-keygen`

![](images/ssh-keygen-carol.png){fig-alt="Terminal screenshot showing ssh-keygen generating a new ed25519 SSH key pair for user carol, including prompts for file location and passphrase, and displaying the key fingerprint and randomart image." width="770"}

:::

::: {.column width="50%"}

### 2. `ssh pico.sh` => pick a username

![](images/pico.sh-signup-carol.png){fig-alt="Terminal interface for pico.sh signup, showing welcome message, account creation instructions, a getting started link, the user's SSH public key fingerprint, and an input field with the username 'carol' entered." width="770"}

:::

::::

That's it!


## Alice hosts a P2P cluster

Alice sets up P2P cluster and gives 'bob' and 'carol' access:

```{r}
#| code-line-numbers: false
[alice]> future.p2p::host_cluster("alice/friends", users=c("bob", "carol"))
```

This is basically setting up a shared message board.

. . .

<br>
Q. What happens if Bob tries to use the P2P cluster?

```{r}
#| code-line-numbers: false
[bob]> plan(future.p2p::cluster, cluster = "alice/friends")
[bob]> y <- future_lapply(xs, slow_sum)
```

. . .

<br>

### Nothing - it will get stuck! Why?


## Contributing P2P workers is easy!

```{r}
#| code-line-numbers: false
[alice]> future.p2p::worker("alice/friends")
```
<div style="height:1ex;"></div>
```{r}
#| code-line-numbers: false
[ bob ]> future.p2p::worker("alice/friends")
```
<div style="height:1ex;"></div>
```{r}
#| code-line-numbers: false
[carol]> future.p2p::worker("alice/friends")
```

. . .

<br>

```{r}
#| code-line-numbers: false
[bob]> plan(future.p2p::cluster, cluster = "alice/friends")
[bob]> y <- future_lapply(xs, slow_sum)
```

<br>

### => Processed on three P2P workers



## Setup can be done from the terminal

Setting up a P2P cluster:

```{r}
#| code-line-numbers: false
{alice}$ Rscript -e future.p2p::host_cluster --cluster=alice/friends \
         --users=bob,carol
```

. . .

Starting P2P workers:

```{r}
#| code-line-numbers: false
{alice}$ Rscript -e future.p2p::worker --cluster=alice/friends &
{alice}$ Rscript -e future.p2p::worker --cluster=alice/friends &
```
<span style="height:10px"/>
```{r}
#| code-line-numbers: false
{ bob }$ Rscript -e future.p2p::worker --cluster=alice/friends &
```
<span style="height:10px"/>
```{r}
#| code-line-numbers: false
{carol}$ Rscript -e future.p2p::worker --cluster=alice/friends &
{carol}$ Rscript -e future.p2p::worker --cluster=alice/friends &
{carol}$ Rscript -e future.p2p::worker --cluster=alice/friends &
```

. . .

<span style="height:10px"/>

### => A shared P2P cluster with 6 workers. More can be added at any time!




## {data-background-color=#D0F0FF}

<center style="font-size: 400%; padding-top: 2.5ex;">
Pros and cons
</center>


## High latency but also high throughput

* High latency:

  - roundtrip takes time, because p2p file transfers take time
  
  - Example: `1+2` takes 2-10 seconds to send, evaluate, and return

  - Just a prototype, so this will be improved

* High throughput:

  - any number of users and workers can join
  
  - a public P2P cluster could have 1000's of P2P workers




## P2P computing requires mutual trust

What if?

```{r}
#| code-line-numbers: false
f <- future(system("erase harddrive"))
```

. . .

Some technical mitigations:

 * End-to-end encryption

 * Run workers in sandboxed environments, e.g. process futures
 
   - in a Linux container, or
   - in a virtual machine
   
   See [**parallelly**](https://parallelly.futureverse.org/articles/parallelly-25-sandbox-workers.html) package for some examples

### => I encourage work on these topics - it's challenging, but important



## {data-background-color=#D0F0FF}

<center style="font-size: 400%; padding-top: 2.5ex;">
The Future is bright<br>
... and fabulous
</center>


## Stay tuned for exiting Futureverse improvements

:::: {.fragments}

### On the horizon {.fragment}

::: {.incremental}

 * Custom random number generators (RNG) [together with Ralf Stubner]

 * Resource specifications, e.g.
   - avoid memory overuse, e.g. `memory=2*GiB`
   - distribute to proper machines, e.g. `memory=2*GiB` and `gpu`
 
:::


### In the near future {.fragment}

::: {.incremental}

 * If you think **furrr** and **future.apply** are neat - just wait!

:::

::::

. . .


## Thank you and may the future be with you!

* It’s easy to get started - just try it
* Support: <https://github.com/HenrikBengtsson/future/discussions>
* Tutorials: <https://www.futureverse.org/tutorials.html>
* Blog posts: <https://www.futureverse.org/blog.html>
* More features on the roadmap
* I love feedback, ideas, and bug reports 💜

![](images/futurize-v1.png){fig-alt="Hexagon-shaped logo with a light blue border, dark blue starry background, and the word 'FUTURIZE' in bold orange gradient letters beneath an upward-pointing arrow symbol." .absolute bottom=70 right=50 width="600"}
